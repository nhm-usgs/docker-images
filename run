#! /bin/bash
#
# U.S. Geological Survey
#
# File - run
#
# Purpose - Simulate NHM run on Shifter, as might be done by Jenkins.
#
# Author - Andrew Halper
#

while getopts "nx" opt; do
    case "$opt" in
    n)  begin=now		# begin Slurm job now (if applicable)
        ;;
    x)  set -x			# run scripts in debug mode
	export X=-x
        ;;
    esac
done

# if on HPC ...
if uname -r | grep cray > /dev/null 2>&1 ; then
    if [ "$begin" = now ]; then
	export BEGIN=`date -d 'now +1 minute' +%H:%M`
    else
	# run as Slurm batch job at 6:00 p.m. MST
	export BEGIN=18:00
	export TZ=MST
    fi
    # ... run on Shifter via Slurm
    sbatch --parsable --job-name=nhm --begin=$BEGIN --export=ALL run.sl
else
    # ... run on Docker
    docker-compose build --parallel base_image

    # ... use base image to mount the Docker volume and examine its
    # contents
    #
    # TODO: this won't work on Git bash on Windows because it's not a
    # TTY; see https://github.com/docker/for-win/issues/1588
    #
    # Also: the "-v" argument here won't work on Windows; see
    # https://stackoverflow.com/questions/35767929/using-docker-via-windows-console-includes-invalid-characters-pwd-for-a-local-v  
    RESTART_DATE=`docker run -it -v nhm_nhm:/nhm \
    			     -w /nhm/NHM-PRMS_CONUS_GF_1_1/restart \
    		             -e TERM=dumb \
		       	     nhmusgs/base bash -c 'ls -1 *.restart' | \
		  sort | tail -1 | cut -f1 -d .`

    # TODO: calculate start/end dates here; see run.sl

    # ... download HRU and PRMS work area archive files
    run data-loader

    # TODO: On Docker (i.e., not Shifter) copy PRMS output from Docker
    # volume to $OUTPUT_DIR directory on host
fi
